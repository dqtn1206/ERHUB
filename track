--[[
    üå± Garden TD Tracker (kh√¥ng debug console)
]]

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local http = http_request or request or (syn and syn.request)
if not http then
    warn("[Tracker] Executor kh√¥ng h·ªó tr·ª£ HTTP.")
    return
end

local HttpService = game:GetService("HttpService")
local Players     = game:GetService("Players")

local player = Players.LocalPlayer
while not player do task.wait() player = Players.LocalPlayer end

local leaderstats = player:WaitForChild("leaderstats", 15)
if not leaderstats then
    warn("[Tracker] Kh√¥ng t√¨m th·∫•y leaderstats.")
    return
end

local seeds = leaderstats:WaitForChild("Seeds", 15)
if not seeds then
    warn("[Tracker] Kh√¥ng t√¨m th·∫•y leaderstats.Seeds.")
    return
end

------------------------------------------------
-- üîë KEY TRACKER
------------------------------------------------
local TRACKER_KEY = "0832007574admin120603"  -- <<< ƒê·ªîI CH·ªñ N√ÄY

local API_URL = "https://dqtntrack.online/api.php"

------------------------------------------------
-- LOAD MODULE Y H·ªÜT SCRIPT RI√äNG C·ª¶A B·∫†N
------------------------------------------------
local ClientDataHandler
local SharedItemData

do
    local playerGui    = player:WaitForChild("PlayerGui")
    local logicHolder  = playerGui:WaitForChild("LogicHolder")
    local clientLoader = logicHolder:WaitForChild("ClientLoader")
    local modulesFolder = clientLoader:WaitForChild("Modules")

    local ok, res = pcall(function()
        local cdh = require(modulesFolder:WaitForChild("ClientDataHandler"))
        local sid = require(modulesFolder:WaitForChild("SharedItemData"))
        return { cdh, sid }
    end)

    if ok and res then
        ClientDataHandler = res[1]
        SharedItemData    = res[2]
        -- ƒë√£ b·ªè h·∫øt print debug
    else
        warn("[Tracker] Kh√¥ng load ƒë∆∞·ª£c ClientDataHandler / SharedItemData:", res)
    end
end

------------------------------------------------
-- H√ÄM ƒê·ª¢I INVENTORY TH·∫¨T S·ª∞ C√ì D·ªÆ LI·ªÜU
------------------------------------------------
local function waitForInventory(timeout)
    timeout = timeout or 30
    local t0 = tick()
    while tick() - t0 < timeout do
        if ClientDataHandler then
            local inv = ClientDataHandler.GetValue("Inventory")
            if inv and next(inv) ~= nil then
                return inv
            end
        end
        task.wait(0.5)
    end
    return ClientDataHandler and ClientDataHandler.GetValue("Inventory") or nil
end

------------------------------------------------
-- ‚úÖ L·∫§Y UNIT THEO SCRIPT RI√äNG, NH∆ØNG ƒê·ªî V·ªÄ D·∫†NG G·ª¨I API
--    m·ªói unit: { id, name, rarity, amount }
------------------------------------------------
local function getUnitStats()
    if not ClientDataHandler or not SharedItemData then
        warn("[Tracker] Ch∆∞a c√≥ ClientDataHandler / SharedItemData.")
        return {
            units       = {},
            totalTypes  = 0,
            totalCount  = 0,
        }
    end

    local inv = waitForInventory(30)
    if not inv then
        warn("[Tracker] Inventory ch∆∞a load (nil) sau th·ªùi gian ch·ªù.")
        return {
            units       = {},
            totalTypes  = 0,
            totalCount  = 0,
        }
    end

    local unitsMap = {}

    for _, entry in pairs(inv) do
        if entry.ItemData and entry.ItemData.ID then
            local item = SharedItemData.GetItem(entry.ItemData.ID)
            if item and item.ItemCategory == "Units" then
                local unitId   = item.ID
                local amount   = entry.Amount or 1
                local unitName = (item.Params and item.Params.Name) or unitId

                local rarityCat   = item.Params and item.Params.RarityCategory or "ra_default"
                local rarityData  = SharedItemData.GetItem(rarityCat)
                local rarityName  = (rarityData and rarityData.Params and rarityData.Params.Name) or "Unknown"
                local rarityOrder = (rarityData and rarityData.Params and rarityData.Params.ImportanceOrder) or 0

                if not unitsMap[unitId] then
                    unitsMap[unitId] = {
                        id          = unitId,
                        name        = unitName,
                        amount      = 0,
                        rarityName  = rarityName,
                        rarityOrder = rarityOrder,
                    }
                end

                unitsMap[unitId].amount = unitsMap[unitId].amount + amount
            end
        end
    end

    local unitsList = {}
    local totalTypes, totalCount = 0, 0

    for _, data in pairs(unitsMap) do
        totalTypes  = totalTypes + 1
        totalCount  = totalCount + data.amount
        table.insert(unitsList, data)
    end

    table.sort(unitsList, function(a, b)
        if a.rarityOrder == b.rarityOrder then
            return a.name < b.name
        else
            return a.rarityOrder > b.rarityOrder
        end
    end)

    local apiUnits = {}
    for _, u in ipairs(unitsList) do
        table.insert(apiUnits, {
            id     = u.id,
            name   = u.name,
            rarity = u.rarityName,
            amount = u.amount,
        })
    end

    return {
        units       = apiUnits,
        totalTypes  = totalTypes,
        totalCount  = totalCount,
    }
end

------------------------------------------------
-- PRESENTS
------------------------------------------------
local presentsLabel

local function findPresentsLabel()
    if presentsLabel and presentsLabel.Parent then
        return presentsLabel
    end

    local pg = player:WaitForChild("PlayerGui")

    local container
    for _, inst in ipairs(pg:GetDescendants()) do
        if inst.Name == "ChristmasGiftsDisplay" then
            container = inst
            break
        end
    end

    if not container then
        return nil
    end

    local label = container:FindFirstChild("Title") or container:FindFirstChildWhichIsA("TextLabel", true)
    if not label then
        return nil
    end

    presentsLabel = label
    return presentsLabel
end

local function getPresents()
    local label = findPresentsLabel()
    if not label then
        return 0
    end

    local text   = tostring(label.Text or "")
    local digits = text:match("%d+")
    if not digits then
        return 0
    end

    local value = tonumber(digits)
    if not value then
        return 0
    end

    return value
end

------------------------------------------------
-- ICON CAPSULE G√ìC D∆Ø·ªöI B√äN PH·∫¢I + POPUP KEY H·∫æT H·∫†N
------------------------------------------------
local KEY_EXPIRED = false

local function createIcon()
    local parentGui

    local ok, hui = pcall(function()
        return gethui and gethui()
    end)

    if ok and hui then
        parentGui = hui
    else
        local success, cg = pcall(function()
            return game:GetService("CoreGui")
        end)

        if success then
            parentGui = cg
        else
            parentGui = player:WaitForChild("PlayerGui")
        end
    end

    local old = parentGui:FindFirstChild("SeedTrackIcon")
    if old then old:Destroy() end

    local gui = Instance.new("ScreenGui")
    gui.Name = "SeedTrackIcon"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    gui.Parent = parentGui

    local capsule = Instance.new("Frame")
    capsule.Name = "Capsule"
    capsule.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    capsule.BackgroundTransparency = 0.90
    capsule.BorderSizePixel = 0
    capsule.AnchorPoint = Vector2.new(1, 1)
    capsule.Position = UDim2.new(1, -12, 1, -12)
    capsule.Size = UDim2.new(0, 55, 0, 28)
    capsule.ZIndex = 9998
    capsule.Parent = gui

    local round = Instance.new("UICorner")
    round.CornerRadius = UDim.new(1, 0)
    round.Parent = capsule

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Thickness = 1.8
    stroke.Transparency = 0.15
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Parent = capsule

    local label = Instance.new("TextLabel")
    label.Name = "Icon"
    label.BackgroundTransparency = 1
    label.BorderSizePixel = 0
    label.AnchorPoint = Vector2.new(0.5, 0.5)
    label.Position = UDim2.new(0.5, 0, 0.5, 0)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.Text = "üçÄ"
    label.TextColor3 = Color3.fromRGB(50, 200, 50)
    label.TextSize = 20
    label.Font = Enum.Font.GothamBold
    label.ZIndex = 9999
    label.Parent = capsule
end

createIcon()

local function showKeyExpiredAndKick()
    if KEY_EXPIRED then return end
    KEY_EXPIRED = true

    local parentGui
    local ok, hui = pcall(function()
        return gethui and gethui()
    end)

    if ok and hui then
        parentGui = hui
    else
        local success, cg = pcall(function()
            return game:GetService("CoreGui")
        end)

        if success then
            parentGui = cg
        else
            parentGui = player:WaitForChild("PlayerGui")
        end
    end

    local old = parentGui:FindFirstChild("KeyExpiredGui")
    if old then old:Destroy() end

    local gui = Instance.new("ScreenGui")
    gui.Name = "KeyExpiredGui"
    gui.IgnoreGuiInset = true
    gui.ResetOnSpawn = false
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Global
    gui.Parent = parentGui

    local frame = Instance.new("Frame")
    frame.AnchorPoint = Vector2.new(0.5, 0.5)
    frame.Position = UDim2.new(0.5, 0, 0.5, 0)
    frame.Size = UDim2.new(0, 380, 0, 120)
    frame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    frame.BackgroundTransparency = 0.05
    frame.BorderSizePixel = 0
    frame.Parent = gui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 14)
    corner.Parent = frame

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(239, 68, 68)
    stroke.Thickness = 2
    stroke.Parent = frame

    local title = Instance.new("TextLabel")
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, -20, 0, 32)
    title.Position = UDim2.new(0, 10, 0, 8)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 20
    title.TextColor3 = Color3.fromRGB(248, 250, 252)
    title.Text = "KEY TRACKER ƒê√É H·∫æT H·∫†N"
    title.TextXAlignment = Enum.TextXAlignment.Center
    title.Parent = frame

    local msg = Instance.new("TextLabel")
    msg.BackgroundTransparency = 1
    msg.Size = UDim2.new(1, -30, 0, 60)
    msg.Position = UDim2.new(0, 15, 0, 40)
    msg.Font = Enum.Font.Gotham
    msg.TextSize = 16
    msg.TextColor3 = Color3.fromRGB(209, 213, 219)
    msg.TextWrapped = true
    msg.Text = "Vui l√≤ng li√™n h·ªá ch·ªß KEY ƒë·ªÉ gia h·∫°n.\nB·∫°n s·∫Ω b·ªã kick kh·ªèi game."
    msg.TextXAlignment = Enum.TextXAlignment.Center
    msg.Parent = frame

    task.spawn(function()
        task.wait(5)
        pcall(function()
            player:Kick("Tracker KEY expired / invalid. Li√™n h·ªá ch·ªß KEY ƒë·ªÉ gia h·∫°n.")
        end)
    end)
end

------------------------------------------------
-- G·ª¨I SEEDS + PRESENTS + UNITS V·ªÄ API
------------------------------------------------
local hasPresentsReady = false

local function sendStatsInternal()
    if KEY_EXPIRED then
        return
    end

    local currentSeeds    = seeds.Value
    local currentPresents = getPresents()
    local unitStats       = getUnitStats()

    local data = {
        username          = player.Name,
        seeds             = currentSeeds,
        presents          = currentPresents,
        unit_total_types  = unitStats.totalTypes,
        unit_total_count  = unitStats.totalCount,
        units             = unitStats.units,
        key               = TRACKER_KEY,
    }

    local json = HttpService:JSONEncode(data)

    local ok, res = pcall(function()
        return http({
            Url     = API_URL,
            Method  = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body    = json
        })
    end)

    if not ok then
        warn("[Tracker] HTTP Error:", res)
        return
    end

    if type(res) == "table" then
        local status = res.StatusCode or res.Status or 0
        local body   = tostring(res.Body or "")

        if status == 403 or body:find("Key expired") or body:find("Invalid key") then
            showKeyExpiredAndKick()
        end
    end
end

local function sendStats()
    if not hasPresentsReady or KEY_EXPIRED then
        return
    end
    sendStatsInternal()
end

task.spawn(function()
    task.wait(10)
    hasPresentsReady = true
    sendStatsInternal()
    while true do
        task.wait(10)
        sendStatsInternal()
    end
end)

seeds:GetPropertyChangedSignal("Value"):Connect(sendStats)
